name: Hourly Sitemap Update

on:
  schedule:
    # Run every hour at the top of the hour
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual triggering
  push:
    branches: [ main, master ]
    paths:
      - 'src/pages/**'
      - 'src/App.jsx'
      - 'scripts/generate-sitemap.js'

env:
  NODE_VERSION: '18'

jobs:
  update-sitemap:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ—ºï¸ Generate fresh sitemap
      run: |
        echo "ğŸš€ Generating sitemap..."
        npm run generate-sitemap
        
        # Check if sitemap was generated
        if [ -f "public/sitemap.xml" ]; then
          echo "âœ… Sitemap generated successfully"
          echo "ğŸ“Š Sitemap contains $(grep -c '<url>' public/sitemap.xml) URLs"
          echo "ğŸ“… Generated on: $(date)"
        else
          echo "âŒ Sitemap generation failed"
          exit 1
        fi

    - name: ğŸ” Check for sitemap changes
      id: check-changes
      run: |
        if git diff --quiet public/sitemap.xml; then
          echo "No changes detected in sitemap"
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "Changes detected in sitemap"
          echo "changed=true" >> $GITHUB_OUTPUT
          
          # Show the changes
          echo "ğŸ“‹ Changes detected:"
          git diff public/sitemap.xml
        fi

    - name: ğŸ“¤ Commit and push sitemap updates
      if: steps.check-changes.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add public/sitemap.xml
        git commit -m "ğŸ—ºï¸ Auto-update sitemap - $(date '+%Y-%m-%d %H:%M UTC')"
        git push

    - name: ğŸ”” Notify search engines
      if: steps.check-changes.outputs.changed == 'true'
      run: |
        echo "ğŸ”” Notifying search engines..."
        
        # Ping Bing (still supports automatic ping)
        BING_PING_URL="http://www.bing.com/ping?sitemap=https://ytvanced.pro/sitemap.xml"
        if curl -s "$BING_PING_URL" > /dev/null; then
          echo "âœ… Successfully notified Bing"
        else
          echo "âš ï¸ Failed to notify Bing"
        fi
        
        # Ping Yandex (still supports automatic ping)
        YANDEX_PING_URL="https://webmaster.yandex.com/ping?sitemap=https://ytvanced.pro/sitemap.xml"
        if curl -s "$YANDEX_PING_URL" > /dev/null; then
          echo "âœ… Successfully notified Yandex"
        else
          echo "âš ï¸ Failed to notify Yandex"
        fi
        
        echo ""
        echo "ğŸ“‹ Manual action required for Google:"
        echo "1. Visit: https://search.google.com/search-console"
        echo "2. Navigate to 'Sitemaps' section"
        echo "3. Reload sitemap: https://ytvanced.pro/sitemap.xml"

    - name: ğŸš€ Trigger Vercel deployment
      if: steps.check-changes.outputs.changed == 'true' && secrets.VERCEL_DEPLOY_HOOK
      run: |
        echo "ğŸš€ Triggering Vercel deployment..."
        curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}"
        echo "âœ… Deployment hook triggered"

    - name: ğŸ“Š Summary
      run: |
        echo "ğŸ¯ Sitemap Update Summary"
        echo "========================"
        echo "ğŸ“… Run time: $(date)"
        echo "ğŸ”„ Changes detected: ${{ steps.check-changes.outputs.changed }}"
        echo "ğŸ“ Sitemap URL: https://ytvanced.pro/sitemap.xml"
        
        if [ -f "public/sitemap.xml" ]; then
          echo "ğŸ“Š Total URLs: $(grep -c '<url>' public/sitemap.xml)"
          echo "ğŸ“ Last modified: $(grep -o '<lastmod>[^<]*</lastmod>' public/sitemap.xml | head -1 | sed 's/<[^>]*>//g')"
        fi
        
        echo ""
        echo "ğŸ” Next steps:"
        if [ "${{ steps.check-changes.outputs.changed }}" == "true" ]; then
          echo "âœ… Sitemap updated and deployed"
          echo "ğŸ“‹ Remember to manually update Google Search Console"
        else
          echo "â„¹ï¸ No updates needed - sitemap is current"
        fi